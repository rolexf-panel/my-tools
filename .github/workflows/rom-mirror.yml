name: ROM Extract to Hugging Face (High Speed)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'Link ROM (GDrive, Mediafire, atau Direct Link)'
        required: true
      rom_name:
        description: 'Nama Folder di HF (misal: A50-Dump)'
        required: true
      hf_repo:
        description: 'Repo ID (contoh: username/my-dataset)'
        required: true
      file_type:
        description: 'Tipe File Sumber'
        type: choice
        required: true
        options:
          - zip
          - rar
        default: zip
      password:
        description: 'Password File (Kosongkan jika tidak ada)'
        required: false
        default: ''

jobs:
  upload-to-hf:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Dependencies
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
        sudo apt-get update
        sudo apt-get install -y aria2 p7zip-full python3-pip
        # Instal yt-dlp sebagai pengganti mediafire-dl
        pip3 install gdown huggingface_hub yt-dlp

    - name: Smart Download
      run: |
        URL="${{ inputs.rom_url }}"
        EXT="${{ inputs.file_type }}"
        OUT="rom.$EXT"

        if [[ "$URL" == *"drive.google.com"* ]]; then
          echo "Mendeteksi Google Drive..."
          gdown --fuzzy "$URL" -O "$OUT"
        
        elif [[ "$URL" == *"mediafire.com"* ]]; then
          echo "Mendeteksi Mediafire (via yt-dlp)..."
          # yt-dlp otomatis menangani direct link Mediafire
          yt-dlp -o "$OUT" "$URL"
        
        else
          echo "Mendeteksi Direct Link (aria2c)..."
          aria2c -x 16 -s 16 -o "$OUT" "$URL"
        fi

    - name: Extract ROM
      run: |
        mkdir -p dump_folder
        # Cek apakah file berhasil didownload sebelum ekstrak
        if [ ! -f "rom.${{ inputs.file_type }}" ]; then
          echo "Error: File rom.${{ inputs.file_type }} tidak ditemukan! Download gagal."
          exit 1
        fi
        
        echo "Mengekstrak..."
        7z x "rom.${{ inputs.file_type }}" -p"${{ inputs.password }}" -odump_folder/ -y
        rm "rom.${{ inputs.file_type }}"

    - name: Upload using Python (Fast & Robust)
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python3 -c '
        from huggingface_hub import HfApi
        import os

        api = HfApi()
        token = os.getenv("HF_TOKEN")
        repo_id = "${{ inputs.hf_repo }}"
        folder_path = "dump_folder"
        path_in_repo = "${{ inputs.rom_name }}"

        if not token:
            print("Error: HF_TOKEN is missing!")
            exit(1)

        print(f"Starting upload to {repo_id}...")
        try:
            api.upload_folder(
                folder_path=folder_path,
                repo_id=repo_id,
                repo_type="dataset",
                path_in_repo=path_in_repo,
                token=token
            )
            print("Upload finished successfully!")
        except Exception as e:
            print(f"Error during upload: {e}")
            exit(1)
        '
